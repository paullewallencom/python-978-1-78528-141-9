"""
Crawls a terrain raster from a starting
point and "floods" everything at the same
or lower elevation by producing a mask
image of 1,0 values.
"""

import numpy as np
from linecache import getline

def floodFill(c,r,mask):
  """
  Crawls a mask array containing
  only 1 and 0 values from the
  starting point (c=column,
  r=row - a.k.a. x,y) and returns
  an array with all 1 values
  connected to the starting cell.
  This algorithm performs a 4-way
  check non-recursively.  
  """
  # cells already filled
  filled = set()
  # cells to fill
  fill = set()
  fill.add((c,r))
  width = mask.shape[1]-1
  height = mask.shape[0]-1
  # Our output inundation array
  flood = np.zeros_like(mask, dtype=np.int8)
  # Loop through and modify the cells which
  # need to be checked.
  while fill:
    # Grab a cell
    x,y = fill.pop()
    if y == height or x == width or x < 0 or y < 0:
      # Don't fill
      continue
    if mask[y][x] == 1:
      # Do fill
      flood[y][x]=1
      filled.add((x,y))
      # Check neighbors for 1 values
      west =(x-1,y)
      east = (x+1,y)
      north = (x,y-1)
      south = (x,y+1)
      if not west in filled:
        fill.add(west)
      if not east in filled:      
        fill.add(east)
      if not north in filled: 
        fill.add(north)
      if not south in filled: 
        fill.add(south)
  return flood 

source = "terrain.asc"
target = "flood.asc"

print "Opening image..."
img = np.loadtxt(source, skiprows=6)
print "Image opened"

a = np.where(img<70, 1,0)
print "Image masked"

# Parse the headr using a loop and
# the built-in linecache module
hdr = [getline(source, i) for i in range(1,7)]
values = [float(h.split(" ")[-1].strip()) for h in hdr]
cols,rows,lx,ly,cell,nd = values
xres = cell
yres = cell * -1

# Starting point for the 
# flood inundation 
sx = 2582
sy = 2057

print "Beginning flood fill"      
fld = floodFill(sx,sy, a)
print "Finished Flood fill"

header=""
for i in range(6):
  header += hdr[i]

print "Saving grid"
# Open the output file, add the hdr, save the array
with open(target, "wb") as f:
  f.write(header)
  np.savetxt(f, fld, fmt="%1i")
print "Done!"



